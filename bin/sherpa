#!/usr/bin/env ruby

require 'optparse'
require './lib/sherpa'

def usage
  puts ARGV.options
  abort
end

def abort_with_note(message=nil)
  $stderr.puts message if message
  abort "See `sherpa --help' for usage information."
end

input = "./"
options = {}
ARGV.options { |o|
  o.on("-i", "--input=FILE") { |file| input += file }
  o.on_tail("-h", "--help") { usage }
  o.parse!
} or abort_with_note


blocks = nil


filetype = File.extname(input).gsub(/\./, "")
if filetype == 'json' || filetype == 'yaml'
  config = (filetype == 'json') ? JSON.parse(File.read(input)) : YAML.load(File.read(input))
else
  abort_with_note("Sherpa requires a .json or .yaml config file")
end


# Send out for the build
if config
  builder = Sherpa::Builder.new(config)
  blocks = builder.build
else
  abort_with_note "Sherpa requires an input file!"
end

# Render outputs
if blocks
  json = JSON.pretty_generate(blocks)
  puts json
  # puts YAML::dump(blocks)
  layout = Sherpa::Layout.new(config, blocks)
  layout.render_and_save
else
  abort_with_note "No blocks found!"
end

